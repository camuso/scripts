#!/bin/bash
#
# init-my-stuff 1.0
# set -x

declare tcmd="| tee -a "$logfile" 2>&1"
declare -i optcount=0
declare remoteuser
declare logfile="$HOME/.initmystuff.log"
declare repolist="rcbak hints etcbk misc ipmi"
declare b_pushpriv=true
declare b_gitrepo=true
declare clonestr
declare distro
declare installagent
declare installflags
declare fetched=false
declare majersion=
declare b_install=false
declare pkg=
declare gitlabtok
declare yumrepo="/etc/yum.repos.d"
declare host="$(hostname)"
declare tmpstr=
declare newuser=
declare majvers
declare -a pkglist

# Init the logfile
> "$logfile"

###############################################################################
# This trick uses the bash DEBUG command to trap every command issued
# and log it into the logfile.
#
log_command() {
	local output=
	local command="$BASH_COMMAND"
	local -a tokens=( $command )

	# Exclude some commands
	case ${tokens[0]} in
		"trap"  ) ;&
		"rptch" ) return
			  ;;
		"for"   ) ;&
		"while" ) echo "$command" >> "$logfile"
			  return
	esac

	output=$({ eval "$command"; } 2>&1)
	grep -q 'echo' <<< "$command" || echo "$command" >> "$logfile"
	[ -n "$output" ] && echo "$output" >> "$logfile"
	# eval "$command" 2>&1 | tee -a "$logfile"
}

# trap 'log_command' DEBUG
###############################################################################

rptch() {
	local ch="$1"
	local -i num="$2"
	local -i idx

	for ((idx = 0; idx < num; ++idx)); do
		echo -n "$ch"
	done
}

tmpstr="$(rptch "*" ${#host})"

echo "******************************$tmpstr"
echo "* Installing environment on $host *"
echo "******************************$tmpstr"

echo "logfile: $logfile" >> "$logfile"

[ -f /etc/os-release ] || { echo "No os-release file!" ; exit 1; }

echo "Getting distro and version information"
distro="$(grep -m1 ID /etc/os-release | awk -F '=' '{print $2}' | tr -d '"')"
echo " distro: $distro"

version="$(grep -m1 VERSION_ID /etc/os-release | awk -F '=' '{print $2}' | tr -d '"')"
echo "version: $version"

if ([[ "$distro" == "rhel" ]] || [[ "$distro" == "centos" ]]); then
	majvers="$(echo "$version" | awk -F '.' '{print $1}')"
	echo "majvers: $majvers"
fi
echo

while getopts hipg OPTION; do
    case "$OPTION" in

	h ) optcount=$((optcount+1))
	    ;;
	i ) optcount=$((optcount+1))
	    b_install=true
	    ;;
	p ) optcount=$((optcount+1))
	    b_pushpriv=true
	    ;;
	g ) optcount=$((optcount+1))
	    b_gitrepo=false
	    ;;
	* ) echo "unrecognized option -$OPTION"
	    exit 127
    esac
done

shift $optcount
remoteuser="$1"
remotehost="$2"
newuser="$3"

echo "remoteuser: $remoteuser"
echo "remotehost: $remotehost"
[ -n "$newuser" ] && echo "newuser: $newuser"

# ========================================================================
# Determine whether dnf or yum is the installagent
# ------------------------------------------------------------------------
#
if [[ "$distro" == "fedora" ]]; then
	installagent=dnf
	installflags="--allowerasing --best --skip-broken"

elif [[ "$distro" == "rhel" ]] || [[ "$distro" == "centos" ]]; then
	if [ $majvers -lt 8 ]; then
		installagent="yum"
		installflags="--nogpgcheck --skip-broken"
	else
		installagent="dnf"
		installflags="--allowerasing --best --skip-broken"
	fi

elif [[ "$distro" == "ubuntu" ]]; then
	installagent='apt-get'
else
	echo "$distro is not a distro supported by this script."
fi

echo

# ========================================================================
# Can't go any further without which rsync, wget, curl, and git
# ------------------------------------------------------------------------
#
# create a method for installing needed executables.
assure() {
	command -v "$1" >/dev/null 2>&1 || $installagent install -y "$1"
}
assure which
assure rsync
assure wget
assure curl
assure git

cd		# make sure we're home

# If we're creating a system that will have push privileges to the
# repos, then use ssh access, else use http.
# For ssh access, the user will have to add the ssh key to the github
# account.
#
$b_pushpriv && clonestr="git clone git@github.com:camuso/" \
	    || clonestr="git clone https://github.com/camuso/"

# Get the gitlab token
# If called by ark2host, then the lab.toml file should be there.
#
if [ -f ~/.config/lab/lab.toml ]; then
	cd ~/.config/lab/
	gitlabtok="$(grep token lab.toml | awk -F' ' '{print $3}' | tr -d \")"
	cd -
else
	echo "No lab.toml file!"
fi

upload_github_ssh_key() {
	local key_type="${1:-ed25519}"
	local key_file
	local priv_file
	local pubkey
	local existing_keys

	# Decide key file path based on type
	if [[ "$key_type" == "rsa" ]]; then
		key_file="$HOME/.ssh/id_rsa.pub"
		priv_file="$HOME/.ssh/id_rsa"
	else
		key_file="$HOME/.ssh/id_ed25519.pub"
		priv_file="$HOME/.ssh/id_ed25519"
	fi

	# Generate key if missing
	if [[ ! -f "$key_file" ]]; then
		echo "No $key_type key found, generating one..."
		mkdir -p "$HOME/.ssh"
		chmod 700 "$HOME/.ssh"
		if [[ "$key_type" == "rsa" ]]; then
			ssh-keygen -t rsa -b 4096 -f "$priv_file" -N ""
		else
			ssh-keygen -t ed25519 -f "$priv_file" -N ""
		fi
	fi

	# Ensure token is present
	if [[ -z "$GITHUB_TOKEN" ]]; then
		echo "Error: GITHUB_TOKEN environment variable not set" >&2
		return 1
	fi

	# Extract just the key data (second field) for comparison
	local key_data
	key_data=$(awk '{print $2}' < "$key_file")

	# Check if key already exists on GitHub
	existing_keys=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
		-H "Accept: application/vnd.github+json" \
		https://api.github.com/user/keys 2>/dev/null)

	if echo "$existing_keys" | grep -qF "$key_data"; then
		echo "SSH key already exists on GitHub. Skipping upload."
		return 0
	fi

	# Prepare title and key
	pubkey=$(<"$key_file")
	local title="${HOSTNAME:-$(hostname)}-$(date +%Y%m%d%H%M%S)"

	# Upload via GitHub API
	echo "Uploading SSH key to GitHub..."
	if curl -s -H "Authorization: token $GITHUB_TOKEN" \
		-H "Accept: application/vnd.github+json" \
		https://api.github.com/user/keys \
		-d "{\"title\":\"$title\",\"key\":\"$pubkey\"}" >/dev/null; then
		echo "SSH key uploaded to GitHub successfully."
	else
		echo "GitHub key upload failed. You may need to enter it manually."
	fi
}

# copy the ssh key to gitlab
#
upload_gitlab_ssh_key() {
	local keyfile
	local local_key
	local existing_keys

	# --- Upload SSH key to GitLab ---
	if [[ -z "$gitlabtok" ]]; then
		return 0
	fi

	# Detect available public key
	if [[ -f ~/.ssh/id_ed25519.pub ]]; then
		keyfile=~/.ssh/id_ed25519.pub
	elif [[ -f ~/.ssh/id_rsa.pub ]]; then
		keyfile=~/.ssh/id_rsa.pub
	else
		echo "No SSH public key found. Skipping GitLab upload."
		return 1
	fi

	# Extract just the key type and key data (without the comment)
	# Format: "ssh-ed25519 AAAA... comment"
	local_key=$(awk '{print $1, $2}' < "$keyfile")

	# Check if key already exists on GitLab
	existing_keys=$(curl --silent \
		--header "PRIVATE-TOKEN: $gitlabtok" \
		https://gitlab.com/api/v4/user/keys 2>/dev/null)

	if echo "$existing_keys" | grep -qF "$(awk '{print $2}' < "$keyfile")"; then
		echo "SSH key already exists on GitLab. Skipping upload."
		return 0
	fi

	echo "Uploading SSH key to GitLab..."
	if curl --silent --show-error --fail \
		--header "PRIVATE-TOKEN: $gitlabtok" \
		--request POST \
		--form "title=$(hostname)-$(date +%Y%m%d)" \
		--form "key=$(<"$keyfile")" \
		https://gitlab.com/api/v4/user/keys >/dev/null; then
		echo "SSH key uploaded to GitLab successfully."
	else
		echo "GitLab key upload failed. You may need to enter it manually."
	fi
}

echo

upload_github_ssh_key
upload_gitlab_ssh_key

echo "*******************************"
echo "* Clone or update Env Files   *"
echo "*******************************"
echo

echo "repolist: $repolist"
for repo in $repolist; do
	if [ -e $repo ]; then
		if [ -d "$repo"/.git ]; then
			echo "Updating $repo"
			cd $repo
			git config pull.rebase false
			git pull
			cd -
		else
			echo "Converting directory $repo to git repo"
			rm -rf $repo
			$clonestr$repo.git $repo
			cd $repo
			git config pull.rebase false
		fi
	else
		echo "Cloning $repo ..."
		$clonestr$repo.git $repo
	fi
	# chown -R tcamuso.tcamuso $repo
	# chmod -R u+wrx,go+rx,go-w $repo
done

echo "*******************************"
echo "* Clone or update bin scripts *"
echo "*******************************"
echo

# Update or create the bin directory.
#
if [ -d bin/.git ]; then
	cd bin
	echo "Updating bin repo..."
	git config pull.rebase false
	git pull
else
	[ -e bin ] && rm -rf bin
	echo "Creating bin repo..."
	${clonestr}scripts.git bin
	cd bin
	git config pull.rebase false
fi
cd
echo "Returning to $PWD..."
echo -e "---------------\n"

# Copy etc and rc files out of their archive directories into their respective
# real directories, but only if they're newer.
#
echo "************************************************"
echo "* Copying Env files from Backup Directories    *"
echo "* but only if they're newer than existing ones *"
echo "************************************************"
echo >> "$logfile"
echo "rsync contents of rcbak to home directory"
rsync -Pat --cvs-exclude rcbak/ .
echo -e "---------------\n"

# Can only do the following if root
# . Change the user's password to the one collected at the beginning
# . Add the user to the NOPASSD users in sudoers
if [ $(id -u) -eq 0 ] && [ -n "$newuser" ] && useradd $newuser; then
	grep -q $newuser /etc/sudoers || \
		echo "$newuser ALL=(ALL)NOPASSWD: ALL" >> /etc/sudoers
	echo "rsync contents of etcbk to /etc"
	rsync -Pat --cvs-exclude etcbk/ /etc/.
fi

echo

# If we are running as root and install has been requested, then install
# the development tools.
#
# Globals:
#   distro
#   version
#   majvers - rhel and centos only
#
get_rcmtools() {
	# local rcmlink="https://download.devel.redhat.com/rel-eng/RCMTOOLS/rcm-tools-rhel"
	local rcmlink="https://download.devel.redhat.com/rel-eng/RCMTOOLS"

	echo "**********************"
	echo "* Getting tools repos *"
	echo "**********************"
	echo

	cd /etc/yum.repos.d

	case "$distro" in
	  "rhel"   ) curl -o rcmtools-rhel-"$majvers".repo \
		     "$rcmlink"/rcm-tools-rhel-"$majvers"-baseos.repo
			;;
	  "fedora" ) curl -o rcmtools-fedora.repo \
		     "$rcmlink"/rcm-tools-fedora.repo
        esac

	if [ "$distro" == "rhel" ]; then
		cd /etc/yum.repos.d
		wget --no-check-certificate "$rcmlink-majvers-baseos.repo"
		cd -
	fi

	yes | dnf copr enable bmeneguele/rhkernel-devtools
	yes | dnf copr enable james/centpkg
	echo
	return 0
}

# Globals:
#   distro
#   version
#   majvers - rhel and centos only
#   installagent - dnf or yum
#
get_epel() {
	echo -n "Installing EPEL for $distro-$majvers"
	$installagent install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-"$majvers".noarch.rpm
	echo
	return 1
}

# Globals:
#   distro
#   version
#   majvers - rhel and centos only
#
get_certs()
{
	# install the RH certs
	# See: https://docs.engineering.redhat.com/display/RCMDOC/RCM+Tools+Release+Guide#RCMToolsReleaseGuide-Installredhat-internal-cert-installrpm
	#

	curl -o /etc/pki/ca-trust/source/anchors/RH-IT-Root-CA.crt \
		https://certs.corp.redhat.com/certs/2015-IT-Root-CA.pem

	curl -o /etc/pki/ca-trust/source/anchors/2022-IT-Root-CA.pem \
		https://certs.corp.redhat.com/certs/2022-IT-Root-CA.pem

	update-ca-trust
}

# Globals:
#   distro
#   version
#   majvers - rhel and centos only
#   installagent - dnf or yum
#
if $b_install && [ "$remoteuser" == "root" ]; then
	declare arch=$(uname -m)
	declare rcmurl=""
	declare filesys

	get_certs
	get_rcmtools

	$installagent copr enable -y bmeneguele/rhkernel-devtools

	if [ "$distro" == "fedora" ]; then
		$installagent copr enable -y james/centpkg
		$installagent install -y fedpkg rhel-packager centpkg-sig
	fi

	if [[ "$distro" == "rhel" ]] || [[ "$distro" == "centos" ]]; then
		get_epel
	fi

	# $installagent groupinstall -y 'X Window System' 'GNOME'

	$installagent group install -y "Development Tools"

	# Install all packages in a single transaction for speed
	# (dnf handles missing packages gracefully with --skip-broken)
	pkglist=(
		annobin
		annobin-annocheck
		automake
		bc
		bind-utils
		bison
		brewkoji
		ca-certificates
		centpkg
		cmake
		conserver-client
		cscope
		dwarves
		elfutils-devel
		elfutils-libelf
		elfutils-libelf-devel
		elfutils-libs
		elinks
		ethtool
		flex
		gcc
		gcc-c++
		git-email
		go
		golang
		hostname
		ipmitool
		kmod
		kmod-libs
		krb5-libs
		krb5-workstation
		lab
		libdwarf
		libdwarf-devel
		libdwarves1
		lynx
		make
		msr-tools
		mutt
		ncurses
		ncurses-devel
		net-tools
		nmap
		OpenIPMI
		openssl
		openssl-devel
		patch
		patchutils
		perl
		pv
		python-bugzilla-cli
		rhpkg
		rpm-build
		rsync
		texinfo
		tpm-tools
		usbutils
		vim
		vim-enhanced
		vim-filesystem
		waiverdb-cli
		watchdog
		xclip
		xorg-x11-apps
		xz
		zenity
	)

	$installagent install -y $installflags "${pkglist[@]}"

	# orphaned packages
	#
	# trousers trousers-devel \
	# koji \
	# http://dl.fedoraproject.org/pub/epel/7/x86_64/q/quilt-0.63-2.el7.noarch.rpm
	# vim-powerline \
	# krb5-auth-dialog \
	# kmodtool \
	# python-bugzilla \
	# git-lab-porcelain

	[ -d /work ] || {
		filesys=$(awk '{print $2}' < <(df -hT | grep -w '/'))
		echo "filesys:$filesys:"
# trap : DEBUG
		case "$filesys" in
			"xfs" ) $HOME/bin/mkworkdir -y
				;;
			"btrfs" ) btrfs subvolume create /work
				;;
		esac
	}
fi
