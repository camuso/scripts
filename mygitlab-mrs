#!/bin/bash

# Script-level variables
declare config_file="$HOME/.config/lab/lab.toml"
declare token=""
declare state="merged"
declare filter_string=""
declare usagestr="$(
cat <<EOF
$(basename "$0") [STATE] [FILTER]

List GitLab merge requests authored by you, filtered by state.

STATE options:
	merged	 Show merged merge requests (default)
	open	 Show open merge requests
	closed	 Show closed merge requests

FILTER (optional):
	A string to filter the output. Only records containing
	this string (case-insensitive) will be displayed.

	Use quotes around the filter if it contains spaces or
	special regex characters (. * + ? [ ] ( ) | ^ $).

Examples:
	$(basename "$0") merged
	$(basename "$0") open
	$(basename "$0") closed
	$(basename "$0") merged "usb"
	$(basename "$0") open "xhci"

EOF
)"

#** usage: print usage information
#*
usage() {
	echo -e "$usagestr"
}

#** exitme: exit with code and optional message
#*
# Arguments
#   $1 - exit code
#   $2 - optional message
#*
exitme() {
	local -i code="$1"
	local msg="$2"

	((code == 0)) && exit "$code"
	[[ -n "$msg" ]] && echo -e "$msg" >&2
	usage
	exit "$code"
}

#** control_c: control-c trap
#*
control_c() {
	echo -e "\nCtrl-c detected\nCleaning up and exiting."
	exitme 1
}

#** check_jq: check if jq is installed, offer to install if not
#*
check_jq() {
	command -v jq &>/dev/null && return 0

	echo "jq is required but not installed."
	read -rp "Would you like to install jq now? (y/n): " response
	if [[ "$response" =~ ^[Yy] ]]; then
	    echo "Installing jq..."
	    sudo dnf install -y jq || exitme 1 "Failed to install jq"
	    echo "jq installed successfully."
	else
	    exitme 1 "jq is required to run this script."
	fi
}

#** check_lab: check if lab is installed, offer to install if not
#*
check_lab() {
	local repo_file="/etc/yum.repos.d/_copr:copr.fedorainfracloud.org:bmeneguele:rhkernel-devtools.repo"

	command -v lab &>/dev/null && return 0

	echo "lab is required but not installed."

	if [[ ! -f "$repo_file" ]]; then
	    echo -e "\nThe rhkernel-devtools COPR repo is not configured."
	    echo "To install lab, you need to add the repo first:"
	    echo ""
	    echo "  sudo dnf copr enable bmeneguele/rhkernel-devtools"
	    echo ""
	    echo "Then run this script again."
	    exitme 1 "Missing required repo for lab installation."
	fi

	read -rp "Would you like to install lab now? (y/n): " response
	if [[ "$response" =~ ^[Yy] ]]; then
	    echo "Installing lab..."
	    sudo dnf install -y lab || exitme 1 "Failed to install lab"
	    echo "lab installed successfully."
	else
	    exitme 1 "lab is required to run this script."
	fi
}

#** check_labconfig: check if lab.toml exists
#*
check_labconfig() {
	if [[ ! -f "$config_file" ]]; then
	    echo "lab configuration file not found at: $config_file"
	    echo ""
	    echo "Please run 'lab' once to configure it with your GitLab token."
	    exitme 1 "Missing lab configuration."
	fi
}

#** get_token: extract token from lab.toml (robust)
#*
get_token() {
	token=$(
	    awk -F'=' '
		/^[[:space:]]*(token|api_token)[[:space:]]*=/ {
		    val=$2
		    gsub(/^[[:space:]]+|[[:space:]]+$/, "", val)
		    gsub(/#.*/, "", val)
		    gsub(/^"[[:space:]]*|[[:space:]]*"$/, "", val)
		    gsub(/^'\''[[:space:]]*|[[:space:]]*'\''$/, "", val)
		    if (val != "") { print val; exit }
		}
	    ' "$config_file"
	)

	if [[ -z "$token" ]]; then
	    exitme 1 "Error: Could not extract token from $config_file"
	fi
}

#** list_mrs: list merge requests by state
#*
# Arguments
#   $1 - state (merged, open, closed)
#   $2 - filter string (optional)
#*
list_mrs() {
	local state_arg="$1"
	local filter="$2"
	local -i page=1

	while true; do
	    local response
	    response=$(curl -s --header "PRIVATE-TOKEN: $token" \
		"https://gitlab.com/api/v4/merge_requests?scope=created_by_me&state=$state_arg&per_page=100&page=$page")

	    local -i count
	    count=$(echo "$response" | jq 'length')

	    if (( count == 0 )); then
		break
	    fi

	    # Apply filter if provided, using jq --arg for safe variable passing
	    if [[ -n "$filter" ]]; then
		echo "$response" | jq --arg f "$filter" '.[] | {
		    project: (.references.full // .web_url),
		    title: .title,
		    merged_at: .merged_at,
		    url: .web_url
		} | select(
		    ((.project // "") | test($f; "i")) or
		    ((.title // "") | test($f; "i")) or
		    ((.url // "") | test($f; "i"))
		)'
	    else
		echo "$response" | jq '.[] | {
		    project: (.references.full // .web_url),
		    title: .title,
		    merged_at: .merged_at,
		    url: .web_url
		}'
	    fi

	    ((page++))
	done
}

#** main: entry point
#*
main() {
	trap control_c SIGINT

	if [[ $# -gt 0 ]]; then
	    case "$1" in
		-h|--help|help)
		    usage; exit 0 ;;
		merged|opened|closed)
		    state="$1" ;;
		*)
		    exitme 1 "Invalid argument: $1" ;;
	    esac
	fi

	# Capture optional filter string (second argument)
	if [[ $# -gt 1 ]]; then
	    filter_string="$2"
	fi

	# Check dependencies
	check_jq
	check_lab
	check_labconfig

	get_token
	list_mrs "$state" "$filter_string"
}

main "$@"

