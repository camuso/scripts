#!/bin/bash
# tboot-add2grub.sh

# ========== Script Globals ==========
boot_dir="/boot"
grub_custom="/etc/grub.d/40_custom"
grub_cfg="/boot/grub2/grub.cfg"
submenu_label="tboot 1.11.9"

# ========== Usage Function ==========
usage() {
	cat <<-EOF

	Usage: $(basename "$0")

	This script adds a GRUB menuentry for the latest tboot-compatible kernel found in /boot.
	It detects the latest vmlinuz-*tboot* kernel, extracts the matching initramfs,
	detects the root UUID, and appends a GRUB stanza to /etc/grub.d/40_custom inside
	a submenu labeled '${submenu_label}'.

	It auto-detects UEFI vs Legacy BIOS and uses the correct GRUB syntax.

	Then it regenerates the GRUB config at ${grub_cfg}.

	Run as root. No arguments required.

	EOF
}

# ========== Exit Function ==========
exitme() {
	local msg="$1"
	echo "Exiting: $msg"
	exit 1
}

# ========== Ctrl-C Trap ==========
trap 'exitme "Interrupted by user (Ctrl-C)";' INT

# ========== Append Entry to Submenu ==========
append_to_submenu() {
	local entry="$1"
	local submenu_exists

	submenu_exists=$(grep -F "submenu '${submenu_label}'" "$grub_custom")

	if [[ -n "$submenu_exists" ]]; then
		# Insert inside existing submenu block
		sed -i "/submenu '${submenu_label}' {/a\\
${entry}
" "$grub_custom" || exitme "Failed to insert entry into existing submenu"
	else
		# Create new submenu block
		echo "submenu '${submenu_label}' {" >> "$grub_custom"
		echo "$entry" >> "$grub_custom"
		echo "}" >> "$grub_custom"
	fi
}

# ========== Main Function ==========
main() {
	local kernel
	local initramfs
	local root_uuid
	local entry
	local boot_mode
	local cmd_multiboot
	local cmd_module

	kernel=$(ls -1 "${boot_dir}"/vmlinuz-*tboot* 2>/dev/null | sort -V | tail -n1 | xargs -n1 basename)
	[[ -z "$kernel" ]] && exitme "No tboot-compatible kernel found in ${boot_dir}"

	initramfs=$(echo "$kernel" | sed 's/^vmlinuz-/initramfs-/').img
	[[ ! -f "${boot_dir}/${initramfs}" ]] && exitme "Missing initramfs: ${initramfs}"

	root_uuid=$(findmnt -no UUID /)
	[[ -z "$root_uuid" ]] && exitme "Unable to detect root UUID"

	boot_mode=$([ -d /sys/firmware/efi ] && echo "UEFI" || echo "Legacy")

	if [[ "$boot_mode" == "UEFI" ]]; then
		cmd_multiboot="linuxefi"
		cmd_module="moduleefi"
	else
		cmd_multiboot="multiboot"
		cmd_module="module"
	fi

	entry="
	menuentry 'Red Hat Enterprise Linux GNU/Linux, with tboot 1.11.9 and Linux ${kernel#vmlinuz-}' {
		insmod part_gpt
		insmod ext2
		search --no-floppy --fs-uuid --set=root ${root_uuid}
		${cmd_multiboot} /boot/tboot.gz logging=serial,memory
		${cmd_module} /boot/${kernel} root=UUID=${root_uuid} ro quiet splash
		${cmd_module} /boot/${initramfs}
	}
"

	append_to_submenu "$entry"

	grub2-mkconfig -o "$grub_cfg" || exitme "Failed to regenerate GRUB config"

	echo "âœ… GRUB entry added for kernel: $kernel inside submenu '${submenu_label}' using ${boot_mode} syntax"
}

# ========== Entrypoint ==========
main "$@"
