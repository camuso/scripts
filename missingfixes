#!/bin/bash
#
# missingfixes

[ "$MYDIR" ]     || declare MYDIR=$(dirname $(which $(basename $0)))
[ "$MYLIB" ]     || declare MYLIB=$MYDIR/lib
[ "$ui_loaded" ] || source $MYLIB/ui.source
[ "$configmanager_loaded" ] || source $MYLIB/config-manager.source
MYDATA=$(realpath ./.data)

declare configfile="$MYDATA/patchreview.conf"
declare remote_dir=
declare outdir=
declare missing_file=
declare usagestr=$(
cat <<EOF

$(basename $0) upstream-tag

Description:

  Parses the missing_fixes generated by patchreview for fixes that were made
  before the optional upstream-tag.

  NOTE:
       Must be executed in a git repo directory that has executed the
       patchreview script.

Arguments:
  upstream-tag - upstream tag to check against. rc and dash  numbers will
                 be ignored.

\0
EOF
)

usage() {
	echo -en "$usagestr"
	exit 1
}

check_repo() {
	[ -d ./.git ] && return 0
	echo -e "$STA$PWD$WRN is not a git repository.$OFF"
	return 1
}

check_configfile() {
	[ -f $configfile ] && return 0
	echo -e "$STA$PWD$WRN does not have a $STA$configfile$WRN file."
	echo -e "${INF}You must run patchreview before running this script.$OFF"
	return 1
}

check_outdir() {
	[ -d "$outdir" ] && return 0
	echo -e "${WRN}There is no patchreview output directory."
	echo -e "${INF}You must run patchreview before running this script.$OFF"
	return 1
}

check_remote_dir() {
	[ -d "$remote_dir" ] && return 0
	echo -e "${WRN}There is no directory named for the upstream repo."
	echo -e "${INF}You must run patchreview before running this script.$OFF"
	return 1
}

check_missingfile() {
	[ -f "$missing_file" ] && return 0
	echo -e "${WRN}There is no $outdir/missing_fixes file."
	echo -e "${INF}You must run patchreview before running this script.$OFF"
}

init() {
	# Config manager stuff
	check_configfile || usage
	cfg_init_ready "$configfile"

	terminal_background=$(cfg_read_key "background")
	ui_set_colors

	check_repo || usage

	outdir=$(cfg_read_key "outdir")
	outdir=$(realpath $outdir)
	check_outdir || usage

	remote_dir=$(cfg_read_key "remote_dir")
	remote_dir=$(realpath $remote_dir)
	check_remote_dir || usage

	missing_file="$outdir/missing_fixes"
	missing_file=$(realpath $missing_file)
	check_missingfile || usage
}

extract_number() {
	str="$1"
	str=$(echo $str | sed 's/[^0-9]*//g')
	echo ${str:0:3}
}

main() {
	local utag=$1
	local tag
	local ltag

	[ ${#@} -eq 1 ] || usage

	init
	cd $remote_dir

	utag=$(extract_number $utag)

	while read line; do
		echo $line | grep -q Missing || continue
		lrc=0
		commit=$(echo $line | cut -d' ' -f5)
		tag=$(git tag --contains $commit | head -1)
		[ -n "$tag" ] || continue

		ltag=$(extract_number $tag)
		[ $ltag -gt $utag ] && continue

		echo -en "${INF}Missing fix from $STA$tag$INF : "
		echo -e $line$OFF | cut -d' ' -f5-
	done < $missing_file

	echo -en $OFF

	cd - > /dev/null 2>&1
}

main $@

exit 0

